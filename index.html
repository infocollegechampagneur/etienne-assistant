<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>√âtienne - Assistant IA √âducatif Qu√©b√©cois</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            margin: 0; 
            background: #f8fafc; 
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .header { 
            background: linear-gradient(135deg, #f97316, #2563eb); 
            color: white; 
            padding: 40px; 
            border-radius: 12px; 
            text-align: center; 
            margin-bottom: 30px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .chat-container { 
            background: white; 
            border-radius: 12px; 
            padding: 25px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            min-height: 500px;
        }
        .message { 
            margin: 15px 0; 
            padding: 15px; 
            border-radius: 8px; 
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .user-message { 
            background: #f1f5f9; 
            text-align: right; 
            border-left: 4px solid #2563eb;
        }
        .ai-message { 
            background: #fef3cd; 
            border-left: 4px solid #f97316;
        }
        .input-container { 
            display: flex; 
            gap: 12px; 
            margin-top: 25px; 
        }
        input { 
            flex: 1; 
            padding: 15px; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            font-size: 16px;
        }
        input:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }
        button { 
            padding: 15px 25px; 
            background: #f97316; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600;
            transition: all 0.2s;
        }
        button:hover { 
            background: #ea580c; 
            transform: translateY(-1px);
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }
        .sources { 
            margin-top: 15px; 
            padding: 12px; 
            background: #f0f9ff;
            border-radius: 6px;
            border: 1px solid #bae6fd;
        }
        .sources ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        .sources li {
            margin: 5px 0;
            color: #0369a1;
        }
        .tabs { 
            display: flex; 
            gap: 12px; 
            margin-bottom: 25px; 
            flex-wrap: wrap; 
        }
        .tab { 
            padding: 12px 18px; 
            background: #f1f5f9; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border: 2px solid #e2e8f0;
        }
        .tab:hover {
            background: #e2e8f0;
        }
        .tab.active { 
            background: #f97316; 
            color: white; 
            border-color: #f97316;
        }
        .test-section { 
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe); 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 25px; 
            border: 2px solid #0ea5e9; 
        }
        .test-button { 
            background: #0ea5e9; 
            margin-right: 12px;
            margin-bottom: 10px;
        }
        .test-button:hover { 
            background: #0284c7; 
        }
        .result { 
            margin-top: 15px; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 8px; 
            font-family: 'Monaco', 'Consolas', monospace; 
            font-size: 13px;
            border: 1px solid #dee2e6;
            white-space: pre-wrap;
        }
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        .trust-score {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .trust-high { background: #dcfce7; color: #166534; }
        .trust-medium { background: #fef3c7; color: #92400e; }
        .messages-container {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì √âtienne</h1>
            <p>Assistant IA pour les √©tudiants qu√©b√©cois</p>
            <p style="font-size: 14px; opacity: 0.9;">Coll√®ge Champagneur ‚Ä¢ Sources Internationales</p>
        </div>

        <!-- Section de test API -->
        <div class="test-section">
            <h3>üß™ Diagnostic de Connexion</h3>
            <button class="test-button" onclick="testAPI()">üîó Test API</button>
            <button class="test-button" onclick="testChatAPI()">üí¨ Test Chat</button>
            <button class="test-button" onclick="testSubjects()">üìö Test Mati√®res</button>
            <div id="testResult" class="result" style="display: none;"></div>
        </div>

        <div class="chat-container">
            <div class="tabs">
                <div class="tab active" onclick="setActiveTab('je_veux')">üéØ Je veux</div>
                <div class="tab" onclick="setActiveTab('je_recherche')">üîç Je recherche</div>
                <div class="tab" onclick="setActiveTab('sources_fiables')">‚úÖ Sources fiables</div>
                <div class="tab" onclick="setActiveTab('activites')">üìö Activit√©s</div>
                <div class="tab" onclick="setActiveTab('verification')">üõ°Ô∏è V√©rification</div>
            </div>

            <div class="messages-container" id="messages"></div>

            <div class="input-container">
                <input type="text" id="messageInput" placeholder="Posez votre question √† √âtienne..." onkeypress="handleKeyPress(event)">
                <button id="sendButton" onclick="sendMessage()">Envoyer</button>
            </div>
        </div>
    </div>

    <script>
        let activeTab = 'je_veux';
        let isLoading = false;

        function setActiveTab(tab) {
            activeTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const placeholders = {
                'je_veux': 'Je veux comprendre...',
                'je_recherche': 'Je recherche des informations sur...',
                'sources_fiables': 'Quelles sont les sources fiables pour...',
                'activites': 'Cr√©ez une activit√© p√©dagogique sur...',
                'verification': 'Collez votre texte √† analyser pour d√©tection IA/plagiat...'
            };
            document.getElementById('messageInput').placeholder = placeholders[tab];
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !isLoading) {
                sendMessage();
            }
        }

        // üß™ TESTS DE DIAGNOSTIC
        async function testAPI() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'üîÑ Test de l\'endpoint /api...';
            
            try {
                console.log('üîç Testing:', window.location.origin + '/api');
                const response = await fetch('/api', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                console.log('‚úÖ Response status:', response.status);
                console.log('‚úÖ Response headers:', Object.fromEntries(response.headers.entries()));
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `‚úÖ API FONCTIONNE!\n${JSON.stringify(data, null, 2)}`;
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `‚ùå API Error ${response.status}:\n${errorText}`;
                }
            } catch (error) {
                console.error('‚ùå API Error:', error);
                resultDiv.innerHTML = `‚ùå ERREUR CRITIQUE:\n${error.message}\n\nV√©rifiez:\n- Backend d√©ploy√©?\n- Variables d'environnement?\n- CORS configur√©?`;
            }
        }

        async function testChatAPI() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'üîÑ Test du chat /api/chat...';
            
            try {
                const testPayload = {
                    message: "Test de connexion √âtienne",
                    message_type: "je_veux",
                    session_id: "test-" + Date.now()
                };
                
                console.log('üì§ Sending payload:', testPayload);
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(testPayload)
                });
                
                console.log('‚úÖ Chat response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `‚úÖ CHAT FONCTIONNE!\nR√©ponse: "${data.response?.substring(0, 100)}..."\nSources: ${data.sources?.join(', ')}`;
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `‚ùå Chat Error ${response.status}:\n${errorText}`;
                }
            } catch (error) {
                console.error('‚ùå Chat Error:', error);
                resultDiv.innerHTML = `‚ùå ERREUR CHAT:\n${error.message}`;
            }
        }

        async function testSubjects() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'üîÑ Test des mati√®res /api/subjects...';
            
            try {
                const response = await fetch('/api/subjects');
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `‚úÖ MATI√àRES OK!\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.innerHTML = `‚ùå Subjects Error: ${response.status}`;
                }
            } catch (error) {
                resultDiv.innerHTML = `‚ùå ERREUR SUBJECTS: ${error.message}`;
            }
        }

        // üí¨ FONCTION CHAT PRINCIPALE
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (!message || isLoading) return;

            // √âtat de chargement
            isLoading = true;
            sendButton.disabled = true;
            sendButton.textContent = '‚è≥';
            input.disabled = true;

            // Afficher message utilisateur
            addMessage(message, 'user');
            input.value = '';

            try {
                if (activeTab === 'verification') {
                    // Analyse de texte
                    const response = await fetch('/api/analyze-text', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ 
                            text: message, 
                            analysis_type: 'complete' 
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        let analysisText = `ü§ñ **D√©tection IA:** ${Math.round(data.ai_detection.ai_probability * 100)}% probabilit√© (${data.ai_detection.confidence})\n\n`;
                        analysisText += `üîç **V√©rification Plagiat:** ${Math.round(data.plagiarism_check.plagiarism_risk * 100)}% risque\n\n`;
                        analysisText += `üó£Ô∏è **Langue d√©tect√©e:** ${data.detected_language === 'en' ? 'Anglais' : 'Fran√ßais'}\n\n`;
                        analysisText += `üí° **Recommandation:** ${data.ai_detection.is_likely_ai ? 'Texte possiblement g√©n√©r√© par IA' : 'Texte semble authentique'}`;
                        
                        addMessage(analysisText, 'ai');
                    } else {
                        addMessage('‚ùå Erreur d\'analyse. V√©rifiez votre texte.', 'ai');
                    }
                } else {
                    // Chat normal
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            message_type: activeTab,
                            session_id: 'web-session-' + Date.now()
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        addMessage(data.response, 'ai', data.sources, data.trust_score);
                    } else {
                        const errorText = await response.text();
                        addMessage(`‚ùå Erreur ${response.status}: V√©rifiez les logs Vercel pour plus de d√©tails.`, 'ai');
                    }
                }
            } catch (error) {
                console.error('üö® Erreur d√©taill√©e:', error);
                console.error('üö® Error stack:', error.stack);
                addMessage(`‚ùå **Erreur de connexion:** ${error.message}\n\nüîß **Actions √† v√©rifier:**\n‚Ä¢ Backend API d√©ploy√©?\n‚Ä¢ Variables d'environnement configur√©es?\n‚Ä¢ R√©seau stable?`, 'ai');
            } finally {
                // Restaurer l'√©tat normal
                isLoading = false;
                sendButton.disabled = false;
                sendButton.textContent = 'Envoyer';
                input.disabled = false;
                input.focus();
            }
        }

        function addMessage(text, sender, sources = null, trustScore = null) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender === 'user' ? 'user-message' : 'ai-message'}`;
            
            let content = `<strong>${sender === 'user' ? 'Vous' : 'üéì √âtienne'}:</strong> ${text.replace(/\n/g, '<br>')}`;
            
            // Afficher trust score
            if (trustScore !== null) {
                const scoreClass = trustScore >= 0.9 ? 'trust-high' : 'trust-medium';
                const scoreText = Math.round(trustScore * 100);
                content += ` <span class="trust-score ${scoreClass}">üîí Fiabilit√©: ${scoreText}%</span>`;
            }
            
            // Afficher sources
            if (sources && sources.length > 0) {
                content += '<div class="sources"><strong>üìö Sources Recommand√©es:</strong><ul>';
                sources.forEach(source => {
                    content += `<li>üîó ${source}</li>`;
                });
                content += '</ul></div>';
            }
            
            messageDiv.innerHTML = content;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Message de bienvenue
        window.onload = () => {
            console.log('üöÄ √âtienne Interface Loaded');
            console.log('üåê Origin:', window.location.origin);
            console.log('üìç Current URL:', window.location.href);
            
            addMessage('Bonjour ! Je suis **√âtienne**, votre assistant IA √©ducatif. ‚ú®\n\nüåç **Nouvelles fonctionnalit√©s:**\n‚Ä¢ Sources anglaises: CliffsNotes, SparkNotes, Lecturia\n‚Ä¢ D√©tection IA et v√©rification plagiat\n‚Ä¢ R√©ponses multilingues FR/EN\n\nüß™ **Cliquez "Test API" ci-dessus pour v√©rifier la connexion !**', 'ai');
        };

        // Gestion d'erreur globale
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('üö® JavaScript Error:', msg, 'at', url + ':' + lineNo);
            return false;
        };
    </script>
</body>
</html>

