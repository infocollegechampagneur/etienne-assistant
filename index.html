<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>√âtienne - Assistant IA √âducatif Qu√©b√©cois</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="√âtienne - Assistant IA pour les √©tudiants qu√©b√©cois fourni par le Coll√®ge Champagneur">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto;
        }
        .header { 
            background: linear-gradient(135deg, #f97316, #2563eb); 
            color: white; 
            padding: 40px; 
            border-radius: 12px; 
            text-align: center; 
            margin-bottom: 30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header p { opacity: 0.95; margin: 5px 0; }
        .chat-container { 
            background: white; 
            border-radius: 12px; 
            padding: 25px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            min-height: 500px;
        }
        .message { 
            margin: 15px 0; 
            padding: 15px; 
            border-radius: 8px; 
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .user-message { 
            background: #e3f2fd; 
            text-align: right; 
            border-left: 4px solid #2563eb;
        }
        .ai-message { 
            background: #fff3e0; 
            border-left: 4px solid #f97316;
        }
        .input-container { 
            display: flex; 
            gap: 12px; 
            margin-top: 25px; 
        }
        input { 
            flex: 1; 
            padding: 15px; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            font-size: 16px;
        }
        input:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }
        button { 
            padding: 15px 30px; 
            background: #f97316; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600;
            transition: all 0.2s;
            font-size: 16px;
        }
        button:hover { 
            background: #ea580c; 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }
        .sources { 
            margin-top: 15px; 
            padding: 15px; 
            background: #f0f9ff;
            border-radius: 8px;
            border-left: 4px solid #0ea5e9;
        }
        .sources ul {
            margin: 10px 0;
            padding-left: 25px;
        }
        .sources li {
            margin: 6px 0;
            color: #0369a1;
        }
        .tabs { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 25px; 
            flex-wrap: wrap; 
        }
        .tab { 
            padding: 12px 18px; 
            background: #f1f5f9; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .tab:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
        }
        .tab.active { 
            background: #f97316; 
            color: white; 
            border-color: #f97316;
        }
        .test-section { 
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe); 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 25px; 
            border: 2px solid #0ea5e9; 
        }
        .test-section h3 {
            margin-bottom: 15px;
            color: #0c4a6e;
        }
        .test-button { 
            background: #0ea5e9; 
            margin-right: 10px;
            margin-bottom: 10px;
            padding: 10px 20px;
            font-size: 14px;
        }
        .test-button:hover { 
            background: #0284c7; 
        }
        .result { 
            margin-top: 15px; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 8px; 
            font-family: 'Monaco', 'Consolas', monospace; 
            font-size: 13px;
            border: 1px solid #dee2e6;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        .trust-score {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        .trust-high { background: #dcfce7; color: #166534; }
        .trust-medium { background: #fef3c7; color: #92400e; }
        .messages-container {
            max-height: 450px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #fafafa;
        }
        .messages-container::-webkit-scrollbar {
            width: 8px;
        }
        .messages-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .messages-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .messages-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        .status-online { background: #10b981; }
        .status-offline { background: #ef4444; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì √âtienne</h1>
            <p>Assistant IA pour les √©tudiants qu√©b√©cois</p>
            <p style="font-size: 14px; opacity: 0.9;">Coll√®ge Champagneur ‚Ä¢ Sources Internationales ‚Ä¢ D√©tection IA ‚Ä¢ V√©rification Plagiat</p>
            <p style="font-size: 12px; margin-top: 10px;">
                <span class="status-indicator status-online"></span>Connect√© √† l'API Vercel
            </p>
        </div>

        <!-- Section de test API -->
        <div class="test-section">
            <h3>üß™ Tests de Diagnostic</h3>
            <button class="test-button" onclick="testAPI()">üîó Tester API</button>
            <button class="test-button" onclick="testChatAPI()">üí¨ Tester Chat</button>
            <button class="test-button" onclick="testSubjects()">üìö Tester Mati√®res</button>
            <button class="test-button" onclick="testAIDetection()">ü§ñ Tester D√©tection IA</button>
            <div id="testResult" class="result" style="display: none;"></div>
        </div>

        <div class="chat-container">
            <div class="tabs">
                <div class="tab active" onclick="setActiveTab('je_veux')">üéØ Je veux</div>
                <div class="tab" onclick="setActiveTab('je_recherche')">üîç Je recherche</div>
                <div class="tab" onclick="setActiveTab('sources_fiables')">‚úÖ Sources fiables</div>
                <div class="tab" onclick="setActiveTab('activites')">üìö Activit√©s</div>
                <div class="tab" onclick="setActiveTab('verification')">üõ°Ô∏è V√©rification</div>
            </div>

            <div class="messages-container" id="messages"></div>

            <div class="input-container">
                <input type="text" id="messageInput" placeholder="Posez votre question √† √âtienne..." onkeypress="handleKeyPress(event)">
                <button id="sendButton" onclick="sendMessage()">Envoyer</button>
            </div>
        </div>
    </div>

    <script>
        let activeTab = 'je_veux';
        let isLoading = false;
        let apiStatus = 'checking';

        // V√©rifier la connexion API au chargement
        window.onload = async () => {
            console.log('üöÄ √âtienne Interface Loaded');
            console.log('üåê Origin:', window.location.origin);
            console.log('üìç Current URL:', window.location.href);
            
            addMessage('Bonjour ! Je suis **√âtienne**, votre assistant IA √©ducatif du Coll√®ge Champagneur. ‚ú®\n\nüåç **Fonctionnalit√©s:**\n‚Ä¢ üìö Sources qu√©b√©coises et internationales (CliffsNotes, SparkNotes, Lecturia)\n‚Ä¢ ü§ñ D√©tection de contenu IA\n‚Ä¢ üîç V√©rification de plagiat\n‚Ä¢ üåê R√©ponses multilingues (FR/EN)\n\nüí° Cliquez sur "üîó Tester API" ci-dessus pour v√©rifier la connexion au backend !', 'ai');
            
            // Test de connexion automatique
            await testAPIStatus();
        };

        async function testAPIStatus() {
            try {
                const response = await fetch('/api', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    apiStatus = 'online';
                    updateStatusIndicator(true);
                    console.log('‚úÖ API Status: Online');
                } else {
                    apiStatus = 'offline';
                    updateStatusIndicator(false);
                    console.warn('‚ö†Ô∏è API Status: Offline');
                }
            } catch (error) {
                apiStatus = 'offline';
                updateStatusIndicator(false);
                console.error('‚ùå API Error:', error);
            }
        }

        function updateStatusIndicator(isOnline) {
            const indicator = document.querySelector('.status-indicator');
            if (indicator) {
                indicator.className = `status-indicator ${isOnline ? 'status-online' : 'status-offline'}`;
            }
        }

        function setActiveTab(tab) {
            activeTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const placeholders = {
                'je_veux': 'üí° Ex: Je veux comprendre les fonctions math√©matiques...',
                'je_recherche': 'üîç Ex: Je recherche des informations sur la R√©volution tranquille...',
                'sources_fiables': '‚úÖ Ex: Quelles sont les sources fiables sur l\'environnement?',
                'activites': 'üìö Ex: Cr√©ez une activit√© p√©dagogique sur les probabilit√©s...',
                'verification': 'üõ°Ô∏è Collez votre texte pour v√©rifier s\'il a √©t√© g√©n√©r√© par IA ou contient du plagiat...'
            };
            document.getElementById('messageInput').placeholder = placeholders[tab];
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !isLoading) {
                sendMessage();
            }
        }

        // üß™ TESTS DE DIAGNOSTIC
        async function testAPI() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'üîÑ Test de l\'endpoint /api...';
            
            try {
                console.log('üîç Testing:', window.location.origin + '/api');
                const response = await fetch('/api', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }
                });
                
                console.log('‚úÖ Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `‚úÖ API FONCTIONNE PARFAITEMENT!\n\n${JSON.stringify(data, null, 2)}`;
                    updateStatusIndicator(true);
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `‚ùå API Error ${response.status}:\n${errorText}`;
                    updateStatusIndicator(false);
                }
            } catch (error) {
                console.error('‚ùå API Error:', error);
                resultDiv.innerHTML = `‚ùå ERREUR DE CONNEXION:\n${error.message}\n\nüîß V√©rifications:\n‚Ä¢ Backend d√©ploy√© sur Vercel?\n‚Ä¢ Variables d'environnement configur√©es?\n‚Ä¢ CORS activ√©?`;
                updateStatusIndicator(false);
            }
        }

        async function testChatAPI() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'üîÑ Test du chat /api/chat...';
            
            try {
                const testPayload = {
                    message: "Test de connexion √âtienne",
                    message_type: "je_veux",
                    session_id: "test-" + Date.now()
                };
                
                console.log('üì§ Sending payload:', testPayload);
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(testPayload)
                });
                
                console.log('‚úÖ Chat response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `‚úÖ CHAT FONCTIONNE!\n\nR√©ponse: "${data.response?.substring(0, 150)}..."\n\nSources: ${data.sources?.length || 0} sources trouv√©es\nScore de confiance: ${data.trust_score || 'N/A'}`;
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `‚ùå Chat Error ${response.status}:\n${errorText}`;
                }
            } catch (error) {
                console.error('‚ùå Chat Error:', error);
                resultDiv.innerHTML = `‚ùå ERREUR CHAT:\n${error.message}`;
            }
        }

        async function testSubjects() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'üîÑ Test des mati√®res /api/subjects...';
            
            try {
                const response = await fetch('/api/subjects');
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `‚úÖ MATI√àRES CHARG√âES!\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.innerHTML = `‚ùå Subjects Error: ${response.status}`;
                }
            } catch (error) {
                resultDiv.innerHTML = `‚ùå ERREUR SUBJECTS:\n${error.message}`;
            }
        }

        async function testAIDetection() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'üîÑ Test de la d√©tection IA /api/detect-ai...';
            
            try {
                const testText = "This is a test text to check if AI detection is working properly. It contains common patterns that might be found in AI-generated content.";
                const response = await fetch('/api/detect-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: testText })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `‚úÖ D√âTECTION IA OP√âRATIONNELLE!\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.innerHTML = `‚ùå AI Detection Error: ${response.status}`;
                }
            } catch (error) {
                resultDiv.innerHTML = `‚ùå ERREUR D√âTECTION IA:\n${error.message}`;
            }
        }

        // üí¨ FONCTION CHAT PRINCIPALE
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (!message || isLoading) return;

            // √âtat de chargement
            isLoading = true;
            sendButton.disabled = true;
            sendButton.textContent = '‚è≥ Envoi...';
            input.disabled = true;

            // Afficher message utilisateur
            addMessage(message, 'user');
            input.value = '';

            try {
                if (activeTab === 'verification') {
                    // Analyse de texte (IA + Plagiat)
                    const response = await fetch('/api/analyze-text', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ 
                            text: message, 
                            analysis_type: 'complete' 
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        let analysisText = `ü§ñ **D√©tection IA:**\n‚Ä¢ Probabilit√©: ${Math.round(data.ai_detection.ai_probability * 100)}%\n‚Ä¢ Confiance: ${data.ai_detection.confidence}\n‚Ä¢ Verdict: ${data.ai_detection.is_likely_ai ? '‚ö†Ô∏è Probablement g√©n√©r√© par IA' : '‚úÖ Semble authentique'}\n\n`;
                        analysisText += `üîç **V√©rification Plagiat:**\n‚Ä¢ Risque: ${Math.round(data.plagiarism_check.plagiarism_risk * 100)}%\n‚Ä¢ Niveau: ${data.plagiarism_check.risk_level}\n‚Ä¢ ${data.plagiarism_check.suspicious_phrases.length} phrases suspectes d√©tect√©es\n\n`;
                        analysisText += `üó£Ô∏è **Langue:** ${data.detected_language === 'en' ? 'üá¨üáß Anglais' : 'üá´üá∑ Fran√ßais'}\n`;
                        analysisText += `üìä **Mots:** ${data.word_count}`;
                        
                        addMessage(analysisText, 'ai');
                    } else {
                        const errorText = await response.text();
                        addMessage(`‚ùå Erreur d'analyse (${response.status}). Veuillez r√©essayer.`, 'ai');
                    }
                } else {
                    // Chat normal
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            message_type: activeTab,
                            session_id: 'web-session-' + Date.now()
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        addMessage(data.response, 'ai', data.sources, data.trust_score);
                    } else {
                        const errorText = await response.text();
                        addMessage(`‚ùå Erreur ${response.status}. Le serveur a rencontr√© un probl√®me. Consultez les logs Vercel pour plus de d√©tails.`, 'ai');
                        console.error('Error response:', errorText);
                    }
                }
            } catch (error) {
                console.error('üö® Erreur compl√®te:', error);
                console.error('üö® Error stack:', error.stack);
                addMessage(`‚ùå **Erreur de connexion:** ${error.message}\n\nüîß **Actions recommand√©es:**\n‚Ä¢ V√©rifiez que le backend est d√©ploy√©\n‚Ä¢ Testez l'API avec le bouton "üîó Tester API"\n‚Ä¢ V√©rifiez votre connexion internet\n‚Ä¢ Consultez la console (F12) pour plus de d√©tails`, 'ai');
            } finally {
                // Restaurer l'√©tat
                isLoading = false;
                sendButton.disabled = false;
                sendButton.textContent = 'Envoyer';
                input.disabled = false;
                input.focus();
            }
        }

        function addMessage(text, sender, sources = null, trustScore = null) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender === 'user' ? 'user-message' : 'ai-message'}`;
            
            let content = `<strong>${sender === 'user' ? 'üë§ Vous' : 'üéì √âtienne'}:</strong> ${text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}`;
            
            // Afficher trust score
            if (trustScore !== null && trustScore !== undefined) {
                const scoreClass = trustScore >= 0.9 ? 'trust-high' : 'trust-medium';
                const scoreText = Math.round(trustScore * 100);
                content += ` <span class="trust-score ${scoreClass}">üîí Fiabilit√©: ${scoreText}%</span>`;
            }
            
            // Afficher sources
            if (sources && sources.length > 0) {
                content += '<div class="sources"><strong>üìö Sources Recommand√©es:</strong><ul>';
                sources.forEach(source => {
                    content += `<li>üîó ${source}</li>`;
                });
                content += '</ul></div>';
            }
            
            messageDiv.innerHTML = content;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Gestion d'erreurs globales
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('üö® JavaScript Error:', msg, 'at', url + ':' + lineNo);
            return false;
        };

        // Log des requ√™tes fetch pour debug
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            console.log('üì° Fetch Request:', args[0]);
            return originalFetch.apply(this, args)
                .then(response => {
                    console.log('üì° Fetch Response:', response.status, response.url);
                    return response;
                })
                .catch(error => {
                    console.error('üì° Fetch Error:', error);
                    throw error;
                });
        };
    </script>
</body>
</html>

